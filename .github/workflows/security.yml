name: Security Scan

on:
  workflow_run:
    workflows: ["CD Pipeline"]  # Asegúrate de que este nombre coincida exactamente porfa
    types:
      - completed

permissions:
  contents: read
  actions: write
  issues: write
  pull-requests: write

jobs:
  zap-scan:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Crear directorio para reportes
        run: mkdir -p zap/wrk

      - name: Escaneo ZAP en producción
        uses: zaproxy/action-full-scan@v0.7.0
        with:
          target: 'http://51.8.61.254/'  # Cambia esto por la URL real de tu entorno en producción
          fail_action: false  # true si quieres que falle el job si encuentra vulnerabilidades
          cmd_options: '-a'   # Escaneo activo

      - name: Verificar archivos generados
        run: |
          echo "Archivos generados por ZAP:"
          ls -R zap/wrk/

      - name: Subir reporte de ZAP
        uses: actions/upload-artifact@v4
        with:
          name: reportezap
          path: zap/wrk/*  # Ajusta si es necesario dependiendo de la ruta generada